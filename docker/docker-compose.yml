version: '3.8'

services:
  # Main ShriSudarshan application
  shri-sudarshan:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: shri-sudarshan:latest
    container_name: shri-sudarshan-app
    
    # Environment configuration - all variables from .env.example
    environment:
      # LLM Provider Configuration
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      
      # OpenAI API Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      
      # Anthropic API Configuration
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      
      # Data Provider API Keys
      - ALPHA_VANTAGE_API_KEY=${ALPHA_VANTAGE_API_KEY}
      - TRADIER_API_KEY=${TRADIER_API_KEY}
      
      # LLM Model Configuration (OpenAI)
      - PREMIUM_MODEL=${PREMIUM_MODEL:-gpt-4o}
      - STANDARD_MODEL=${STANDARD_MODEL:-gpt-4o-mini}
      
      # LLM Model Configuration (Anthropic)
      - ANTHROPIC_PREMIUM_MODEL=${ANTHROPIC_PREMIUM_MODEL:-claude-3-5-sonnet-20241022}
      - ANTHROPIC_STANDARD_MODEL=${ANTHROPIC_STANDARD_MODEL:-claude-3-5-sonnet-20241022}
      
      # Memory Configuration
      - CHROMA_PERSIST_DIRECTORY=${CHROMA_PERSIST_DIRECTORY:-/app/data/chroma_db}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///./data/episodic_memory.db}
      
      # Redis Configuration (Optional)
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      
      # System Configuration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      
      # Risk Management Parameters
      - MAX_POSITION_SIZE=${MAX_POSITION_SIZE:-0.05}
      - MAX_PORTFOLIO_RISK=${MAX_PORTFOLIO_RISK:-0.02}
      - MAX_SECTOR_CONCENTRATION=${MAX_SECTOR_CONCENTRATION:-0.25}
      
      # Execution Configuration
      - PAPER_TRADING=${PAPER_TRADING:-true}
      - BROKER_API_ENDPOINT=${BROKER_API_ENDPOINT}
      - BROKER_API_KEY=${BROKER_API_KEY}
      
      # Agent Configuration
      - ENABLE_CONCURRENT_ANALYSIS=${ENABLE_CONCURRENT_ANALYSIS:-true}
      - MAX_DEBATE_ROUNDS=${MAX_DEBATE_ROUNDS:-3}
      - ANALYSIS_TIMEOUT_SECONDS=${ANALYSIS_TIMEOUT_SECONDS:-30}
      
      # FinBERT and FinGPT Configuration
      - FINBERT_MODEL=${FINBERT_MODEL:-ProsusAI/finbert}
      - FINGPT_MODEL=${FINGPT_MODEL:-FinGPT/fingpt-forecaster_dow30_llama2-7b_lora}
      - FINGPT_USE_LOCAL=${FINGPT_USE_LOCAL:-true}
      
      # Data Configuration
      - MARKET_DATA_CACHE_TTL=${MARKET_DATA_CACHE_TTL:-300}
      - NEWS_LOOKBACK_DAYS=${NEWS_LOOKBACK_DAYS:-7}
      - HISTORICAL_DATA_PERIOD=${HISTORICAL_DATA_PERIOD:-1y}
    
    # Volume mounts for data persistence
    volumes:
      # Persistent data storage
      - ../data:/app/data
      # Mount .env file (read-only)
      - ../.env:/app/.env:ro
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
    
    # Network configuration
    networks:
      - shri-network
    
    # Restart policy
    restart: unless-stopped
    
    # Default command - paper trading mode
    command: ["python", "src/main.py", "--symbol", "AAPL", "--paper-trading"]
    
    # For interactive usage
    stdin_open: true
    tty: true

  # Optional: PostgreSQL database (for production episodic memory)
  postgres:
    image: postgres:15-alpine
    container_name: shri-sudarshan-postgres
    environment:
      POSTGRES_DB: shri_sudarshan
      POSTGRES_USER: shri_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - shri-network
    restart: unless-stopped
    profiles:
      - production
      - full

  # Optional: Redis (for distributed working memory)
  redis:
    image: redis:7-alpine
    container_name: shri-sudarshan-redis
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - shri-network
    restart: unless-stopped
    profiles:
      - production
      - full

# Named volumes for data persistence
volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local

# Network configuration
networks:
  shri-network:
    driver: bridge
